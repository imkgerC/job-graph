<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Timetables</title>
    <style>
        body,
        html {
            margin: 0;
            width: 100%;
            height: 100%;
        }

        body {
            background: #eee;
            height: 100vh;
        }

        #main {
            color: #222;
            padding-top: 1em;
            width: 100%;
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
            gap: 1em;
            font-size: 1.7em;
            font-family: Arial, Helvetica, sans-serif;
        }
        
        #main-container {
            border: #222 solid 3px;
            height: 100%;
            justify-content: top;
            display: flex;
            flex-direction: column;
            padding-left: 0.3em;
            padding-right: 0.3em;
        }

        .departure-on-time {
            color: green;
        }

        .departure-late {
            color: red;
        }

        tr {
            border-bottom: #222 solid 1px;
        }

        th {
            padding-right: 0.5em;
        }

        th {
            padding-left: 0.5em;
        }

        td {
            padding-left: 0.5em;
        }

        table {
            border-collapse: collapse;
        }

        thead {
            border-bottom: solid #222;
        }
    </style>
</head>

<body>
    <div id="main">
        <div id="main-container">
            <h1>Technologiepark</h1>
            <div data-stop-id="08221:1226"></div>
        </div>
        <div id="main-container">
            <h1>Bunsengymnasium</h1>
            <div data-stop-id="08221:1228"></div>
        </div>
        <div id="main-container">
            <h1>Rohrbach Markt</h1>
            <div data-stop-id="08221:1276"></div>
        </div>
    </div>
</body>
<script type="module">
    await (async () => {
        async function make_vrn_request(stop) {
            const fetch_url = "https://corsproxy.io/?" +
                "https://www.vrn.de/mngvrn/XML_DM_REQUEST?" +
                "coordOutputFormat=EPSG:4326&depType=stopEvents&" +
                "includeCompleteStopSeq=1&limit=7&mode=direct&" +
                `name_dm=de:${stop}&` +
                "outputFormat=json&type_dm=any&useOnlyStops=1&useRealtime=1";
            
            const response = await fetch(fetch_url);
            return await response.json();
        }

        function get_date_from_json(data) {
            return new Date(data.year, data.month-1, data.day, data.hour, data.minute);
        }

        function create_arrival_component(arrival_data) {
            const element = document.createElement("tr");

            const destination = arrival_data.servingLine.direction;
            const line_number = arrival_data.servingLine.number;
            const planned_time = get_date_from_json(arrival_data.dateTime);
            
            let expected_time;
            if (arrival_data.realDateTime) {
                expected_time = get_date_from_json(arrival_data.realDateTime);
            }
            else {
                expected_time = undefined
            }

            const formatDate = (d) => d ? d.toLocaleTimeString("de-de", {hour: '2-digit', minute:'2-digit'}) : "";
            const createTd = (text) => {
                const e = document.createElement("td");
                e.innerText = text;
                return e;
            }

            const departure = document.createElement("td");
            const planned = document.createElement("div");
            planned.innerText = formatDate(planned_time);
            const expected = document.createElement("div");
            expected.innerText = formatDate(expected_time);
            expected.className = "departure-on-time";
            if (expected_time > planned_time) {
                expected.className = "departure-late";
            }
            departure.appendChild(planned);
            departure.appendChild(expected);

            element.appendChild(departure);
            
            element.appendChild(createTd(line_number.replace("RNV ", "")));
            element.appendChild(createTd(destination));
            return element;
        }

        async function update_stop(stop_div) {
            stop_div.innerHTML = "";
            const table = document.createElement("table");

            // create header
            const head = document.createElement("thead");
            const createTh = (text) => {
                const e = document.createElement("th");
                e.innerText = text;
                return e;
            }
            head.appendChild(createTh("Abfahrt"))
            head.appendChild(createTh("Linie"))
            head.appendChild(createTh("Richtung"))
            table.appendChild(head);

            const data = await make_vrn_request(stop_div.getAttribute("data-stop-id"));
            const body = document.createElement("tbody");
            const departures = data.departureList;
            departures.map(create_arrival_component).forEach(element => {
                body.appendChild(element)
            });
            table.appendChild(body);

            stop_div.appendChild(table);
        }

        let stops = document.querySelectorAll("[data-stop-id]");
        let promises = [];
        for (let i = 0; i < stops.length; ++i) {
            const promise = update_stop(stops[i]);
            promises.push(promise);
        }
        await Promise.all(promises);
    })();
</script>

</html>